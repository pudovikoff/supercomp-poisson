#!/bin/bash
#BSUB -n 10
#BSUB -W 00:30
#BSUB -J "poisson_mpi_omp_table3"
#BSUB -o "poisson_mpi_omp_table3.%J.out"
#BSUB -e "poisson_mpi_omp_table3.%J.err"
#BSUB -R "affinity[core(2)]"
export OMP_NUM_THREADS=16     # 10 ?^?де?^? ?^? 8 по?^?оков на ?^?д?^?о


# Скрипт для заполнения Таблицы 3: MPI+OpenMP код на IBM Polus
# 
# Таблица 3: Результаты расчетов на ПВС IBM Polus (MPI+OpenMP код)
# Конфигурации:
# - 2 процесса × {1, 2, 4, 8} нитей, сетка 400×600
# - 4 процесса × {1, 2, 4, 8} нитей, сетка 800×1200

echo "=========================================================================="
echo "Таблица 3: Результаты расчетов на ПВС IBM Polus (MPI+OpenMP код)"
echo "=========================================================================="
echo "Задание: $LSB_JOBID"
echo "Узел: $(hostname)"
echo "Дата: $(date)"
echo "=========================================================================="

# Загрузка модулей
module load SpectrumMPI

# Исправление perl warnings о локали
export LC_ALL=C
export LANG=C

# Проверка наличия бинарника
if [ ! -f "./bin/poisson_mpi_omp" ]; then
    echo "ОШИБКА: файл ./bin/poisson_mpi_omp не найден!"
    echo "Выполните: make mpi_omp"
    exit 1
fi

echo ""
echo "Начало тестов..."
echo ""

# Заголовок таблицы результатов
echo "=========================================================================="
echo "Результаты тестов:"
echo "=========================================================================="
printf "%-15s %-15s %-15s %-12s %-15s %-12s\n" "MPI процессов" "OpenMP нитей" "Сетка (M×N)" "Итерации" "Время (с)" "Ускорение"
echo "--------------------------------------------------------------------------"

# Сохраним базовое время для расчета ускорения (первая конфигурация)
BASE_TIME=""

# Массивы конфигураций
# Группа 1: 2 процесса, сетка 400×600
NP_ARRAY_1=(2 2 2 2)
THREADS_ARRAY_1=(1 2 4 8)
M_ARRAY_1=(400 400 400 400)
N_ARRAY_1=(600 600 600 600)

# Группа 2: 4 процесса, сетка 800×1200
NP_ARRAY_2=(4 4 4 4)
THREADS_ARRAY_2=(1 2 4 8 16)
M_ARRAY_2=(800 800 800 800 2000)
N_ARRAY_2=(1200 1200 1200 1200 3200)

# Объединяем массивы
ALL_NP=(${NP_ARRAY_1[@]} ${NP_ARRAY_2[@]})
ALL_THREADS=(${THREADS_ARRAY_1[@]} ${THREADS_ARRAY_2[@]})
ALL_M=(${M_ARRAY_1[@]} ${M_ARRAY_2[@]})
ALL_N=(${N_ARRAY_1[@]} ${N_ARRAY_2[@]})

# Счетчик тестов
TOTAL_TESTS=${#ALL_NP[@]}

# Цикл по всем конфигурациям
for i in $(seq 0 $((TOTAL_TESTS - 1))); do
    NP=${ALL_NP[$i]}
    THREADS=${ALL_THREADS[$i]}
    M=${ALL_M[$i]}
    N=${ALL_N[$i]}
    
    echo ""
    echo ">>> Тест $((i + 1))/$TOTAL_TESTS: $NP MPI процессов × $THREADS OpenMP нитей, сетка ${M}×${N}"
    echo ""
    
    # Запуск программы
    OUTPUT=$(mpiexec -n $NP ./bin/poisson_mpi_omp --M $M --N $N --threads $THREADS 2>&1)
    
    # Вывод результатов программы (опционально, можно закомментировать)
    # echo "$OUTPUT"
    
    # Извлечение результатов
    ITERS=$(echo "$OUTPUT" | grep "Iterations:" | awk '{print $2}')
    TIME=$(echo "$OUTPUT" | grep "Time:" | awk '{print $2}')
    NORM_E=$(echo "$OUTPUT" | grep "||w||_E" | awk -F'= ' '{print $2}' | awk -F',' '{print $1}')
    NORM_C=$(echo "$OUTPUT" | grep "||w||_C" | awk -F'= ' '{print $2}')
    
    if [ -z "$TIME" ]; then
        echo "ВНИМАНИЕ: не удалось извлечь время выполнения"
        printf "%-15s %-15s %-15s %-12s %-15s %-12s\n" "$NP" "$THREADS" "${M}×${N}" "N/A" "N/A" "N/A"
    else
        # Сохраняем базовое время (первая конфигурация)
        if [ -z "$BASE_TIME" ]; then
            BASE_TIME=$TIME
            SPEEDUP="1.00"
        else
            SPEEDUP=$(echo "scale=2; $BASE_TIME / $TIME" | bc)
        fi
        
        # Вывод строки таблицы
        printf "%-15s %-15s %-15s %-12s %-15s %-12s\n" "$NP" "$THREADS" "${M}×${N}" "$ITERS" "$TIME" "$SPEEDUP"
        
        # Дополнительная информация (для проверки)
        echo "  ||w||_E = $NORM_E, ||w||_C = $NORM_C"
    fi
    
    echo ""
    echo "---"
done

echo ""
echo "=========================================================================="
echo "Все тесты завершены"
echo "Время завершения: $(date)"
echo "=========================================================================="

echo ""
echo "Примечания:"
echo "  - Ускорение рассчитано относительно первой конфигурации (2 процесса × 1 нить)"
echo "  - Для корректного сравнения желательно также запустить последовательную"
echo "    версию на соответствующих сетках для получения абсолютного ускорения"
echo ""
echo "Результаты сохранены в: poisson_mpi_omp_table3.$LSB_JOBID.out"
