#!/bin/bash
#BSUB -n 16
#BSUB -W 00:30
#BSUB -J "poisson_mpi_scaling"
#BSUB -o "poisson_mpi_scaling.%J.out"
#BSUB -e "poisson_mpi_scaling.%J.err"


# Скрипт для тестирования масштабируемости MPI версии
# 
# Запускает программу с разным количеством процессов (1, 2, 4, 8, 16)
# на одной и той же сетке для измерения ускорения

# Параметры сетки (фиксированные)
M=40
N=40

echo "=========================================="
echo "Poisson Solver - Тест масштабируемости"
echo "=========================================="
echo "Задание: $LSB_JOBID"
echo "Узел: $(hostname)"
echo "Дата: $(date)"
echo "Сетка: ${M} x ${N}"
echo "=========================================="

# Загрузка модулей
module load SpectrumMPI

# Исправление perl warnings о локали
export LC_ALL=C
export LANG=C

# Проверка наличия бинарника
if [ ! -f "./bin/poisson_mpi" ]; then
    echo "ОШИБКА: файл ./bin/poisson_mpi не найден!"
    echo "Выполните: make mpi"
    exit 1
fi

echo ""
echo "Начало тестов..."
echo ""

# Массив с количеством процессов для тестирования
NP_ARRAY=(1 2 4 8 16)

# Заголовок таблицы результатов
echo "=========================================="
echo "Результаты тестов:"
echo "=========================================="
printf "%-12s %-12s %-12s\n" "Процессов" "Время (с)" "Ускорение"
echo "------------------------------------------"

# Сохраним время для 1 процесса для расчета ускорения
BASE_TIME=""

for NP in "${NP_ARRAY[@]}"; do
    echo ""
    echo ">>> Запуск с $NP процессами..."
    echo ""
    
    # Запуск и захват вывода
    OUTPUT=$(mpiexec -n $NP ./bin/poisson_mpi --M $M --N $N 2>&1)
    
    # Вывод результатов программы
    echo "$OUTPUT"
    
    # Извлечение времени из вывода (предполагается формат "Time: X.XXXXXX s")
    TIME=$(echo "$OUTPUT" | grep "Time:" | awk '{print $2}')
    
    if [ -z "$TIME" ]; then
        echo "ВНИМАНИЕ: не удалось извлечь время выполнения"
        continue
    fi
    
    # Сохраняем базовое время (для 1 процесса)
    if [ "$NP" -eq 1 ]; then
        BASE_TIME=$TIME
    fi
    
    # Вычисляем ускорение
    if [ -n "$BASE_TIME" ] && [ "$NP" -gt 1 ]; then
        SPEEDUP=$(echo "scale=2; $BASE_TIME / $TIME" | bc)
    else
        SPEEDUP="1.00"
    fi
    
    # Выводим строку таблицы
    printf "%-12s %-12s %-12s\n" "$NP" "$TIME" "$SPEEDUP"
    
    echo ""
    echo "---"
done

echo ""
echo "=========================================="
echo "Тесты завершены"
echo "Время завершения: $(date)"
echo "=========================================="

echo ""
echo "Результаты также сохранены в: poisson_mpi_scaling.$LSB_JOBID.out"
g